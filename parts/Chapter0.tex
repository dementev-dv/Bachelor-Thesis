\section{Введение}
\label{sec:Chapter0} \index{Chapter0}

\subsection{Файловая система}

Одна из основных функций операционной системы (ОС) - управление устройствами долговременного хранения информации и предоставление пользовательским приложениям интерфейса для взаимодействия с ними с целью хранения и организации доступа к данным. Элемент операционной системы, отвечающий за эти функции - \textbf{файловая система} (ФС) \cite{osbook}. 

Для интеграции ряда файловых систем в единую структуру с пользовательской точки зрения в ядре ОС Linux используется концепция виртуальной файловой системы, позволяющая обращаться к различным файловым системам, используя единый интерфейс системных вызовов. Для оптимизации своей работы ФС использует множество внутренних структур данных. Для хранения метаданных пользовательских файлов и каталогов ФС использует структуру данных, называемую \textbf{индексным дескриптором}. Также для хранения информации о свободном пространстве на устройстве файловые системы используют особые структуры данных, например, битовую карту данных или список свободных блоков устройства. Для оптимизации процесса монтирования вся информация о файловой системе необходимая ОС в процессе монтирования хранится в структуре, называемой \textbf{суперблоком}.

\subsection{Устройства долговременного хранения информации}

Большинство файловых систем ядра Linux были разработаны для взаимодействия с накопителями на жестком магнитном диске, особенности строения которых формировали алгоритмы хранения данных, используемые файловыми системами. Подобные устройства хранения состоят из вращающегося диска с магнитными дорожками и считывающей головки, способной перемещаться между дорожками. Из-за подобного строения доступ к произвольному блоку данных на жестком диске имел задержку позиционирования считывающей головки над нужной дорожкой и задержку вращения диска, обусловленную скоростью вращения магнитного диска. Для оптимизации задержки вращения в файловых системах использовались различные алгоритмы размещения данных на диске, например, размещение файлов из одного каталога и их индексных дескрипторов поблизости.

С развитием технологий на рынке устройств долговременного хранения информации начали появляться аналоги жестким дискам в виде \textbf{устройств флэш-памяти} \cite{embedded}. Устройства флэш-памяти состоят из транзисторов, за счет чего скорость доступа к произвольному блоку имеет тот же порядок, что и скорость последовательного доступа к данным. Ячейки флэш-памяти организованы в так называемые \textbf{стираемые блоки}, которые обычно имеют размер 128 килобайт. Интерфейс взаимодействия с устройствами флэш-памяти отличается от интерфейса жесткого диска и составляет три основные команды: чтение данных из блока, стирание всего блока, то есть установка всех его бит в единицу, и программирование памяти, то есть замена части единичных бит на нули для записи нужных данных, что может быть осуществлено после стирания блока.

Главная проблема флэш-памяти - износ. В процессе стирания и перезаписи блока на транзисторах накапливается избыточный заряд, из-за чего становится невозможно определить значение на транзисторе, и блок становится непригодным к использованию. Время жизни блоков флэш-памяти измеряется в циклах стирания и имеет значение порядка 100000 циклов. Для предотвращения излишнего использования определенных блоков и продления срока службы всей микросхемы используется технология \textbf{выравнивания износа} блоков, что означает равномерное использование всех блоков.

\subsection{Взаимодействие ФС с флэш-памятью}

Для эффективного использования флэш-памяти в качестве запоминающего устройства необходимо разрешить несколько основных проблем: выравнивание износа, обеспечение надежности в случае отключения питания, сборка мусора и необходимость программной обработки дефектных блоков. Эти проблемы решаются \textbf{уровнем флэш-преобразования} (FTL). 

Уровень флэш-преобразования может быть размещен в контроллере устройства памяти, в драйвере устройства или в файловой системе, как это реализовано в JFFS2 и других ФС, взаимодействующих с неуправляемой флэш-памятью, например, UBIFS и YAFFS2.

\subsection{Устройства на основе технологии памяти}

Для доступа к неуправляемой флэш-памяти, то есть не имеющей контроллера выполняющего функции FTL, в ядре Linux используется система устройств на основе \textbf{технологии памяти} (MTD - Memory Technology Device) \cite{mtd}, предоставляющая базовые интерфейсы для взаимодействия с устройствами, а также обработки и идентификации дефектных блоков. Структура подсистемы MTD проиллюстрирована на рис. ~\ref{mtdfigure}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{mtd-noback.png}
	\caption{Подсистема устройств технологии памяти (MTD)}
	\label{mtdfigure}
\end{figure}

Она состоит из трех уровней: основной набор функций, драйверы микросхем флэш-памяти и драйверы пользовательского уровня, предоставляющие пользователю интерфейс символьного и блочного устройства для взаимодействия с флэш-памятью. 

\subsection{Устройства с несортированными блоками}

Подсистема \textbf{образов с несортированными блоками} (UBI - Unsorted Block Images) является частью модуля MTD. UBI предоставляет механизм абстракции над устройствами технологии памяти в виде томов, состоящих из логических стираемых блоков. Каждому логическому блоку соответствует физический стираемый блок устройства, при том соседние логические блоки необязательно будут связаны с соседними физическими блоками устройства. Помимо возможности разделения устройства на несколько томов, такая абстракция помогает избавить файловую систему от проблем обработки дефектных блоков устройства. Дефектные блоки находятся подсистемой UBI и не включаются в томы. Механизм работы UBI продемонстрирован  на рис. ~\ref{ubifigure}.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.6]{ubi.png}
	\caption{Томы с несортированными блоками (UBI)}
	\label{ubifigure}
\end{figure}

\subsection{Файловая система JFFS2}

Файловая система JFFS2 (Journaling Flash Filesystem 2) \cite{jffs2} была разработана для использования неуправляемых микросхем флэш-памяти в качестве запоминающего устройства и поддерживает устройства как NOR, так и NAND типа. JFFS2 является исторически первой файловой системой Linux для флэш-накопителей, но используется до сих пор \cite{embedded}. Она имеет журнальную структуру и использует подсистему устройств технологий памяти MTD для доступа к флэш-памяти.

Для того, чтобы избежать чтения всего журнала для вычисления структуры каталогов на этапе монтирования, JFFS2 использует сводные узлы (summary node). Сводный узел записывается в конец открытого стираемого блока и содержит в себе всю информацию, необходимую на этапе монтирования. Такой подход позволяет уменьшить время монтирования ценой небольшого перерасхода объема используемой памяти. Этот режим включается при установке определенного конфигурационного параметра ядра.

С целью различить, является ли стираемый блок, в котором все биты установлены в 1, очищенным, или он хранит полезную информацию, состоящую из всех единичных бит, JFFS2 использует маркеры очистки (clean marker), записываемые в начале блока. Если маркер очистки присутствует в блоке, значит блок очищен.

\subsection{Тестирования файловых систем}

Обеспечение надежности и отказоустойчивости модулей ядра, и файловой системы в частности - важная и непростая задача \cite{ostesting}. Наличие ошибок в исходном коде ФС может привести к нарушениям в основных функциях файловой системы, получению пользователем несанкционированного доступа к привилегированному режиму ядра, а также полному краху или блокировке системы. Подобные последствия ошибок на серверах и суперкомпьютерах могут привести к потерям значимых данных или несанкционированному доступу к ним.

Большинство веб-серверов и суперкомпьютеров используют операционные системы на основе ядра Linux, имеющего открытый исходный код. В ядре Linux имеется множество файловых систем, разработанных для различных типов устройств хранения информации и использующие различные алгоритмы расположения данных на устройстве.

Решением для проверки корректности функционирования операционных систем и их модулей является создание систем автоматизированного тестирования.  

Системы автоматизированного тестирования файловых систем должны тестировать код на наличие ошибок разного характера, принимая во внимание особенности архитектуры тестируемого модуля. Например, код файловых систем, и JFFS2 в частности, содержит функции, выполняющиеся параллельно, которые в случае некорректной работы могут привести к конкуренции за данные (data races) или взаимной блокировке параллельно исполняющихся функций (deadlock).

Стандартный подход к тестированию ФС заключается в создании тестов пространства пользователя с детерминированным результатом. Такие тесты реализуются в виде последовательности системных вызовов для взаимодействия с функционалом ФС. Такой подход к тестированию ФС является наиболее популярным и хорошо подходит для обнаружения дефектов в участках ФС, отвечающих за стандартный сценарий работы модуля.

\subsection{Симуляция сбоев}

Исходный код любого модуля ядра, и в частности ФС, содержит множество строк кода, обрабатывающих редкие сценарии ошибок. Для тестирования подобного кода применяют специальные подходы, например, тестирование с использованием \textbf{симуляции сбоев} (fault injection) \cite{faultuse}.

С использованием этого подхода, в вызываемых функциях симулируются условия, вызывающие ошибки в процессе их исполнения. С точки зрения вызывающей функции сценарий ее работы выглядит, как если бы вызываемая функция вернула код ошибки в случае нехватки памяти, обнаружении невалидных данных или невозможности доступа к запоминающему устройству.

\subsection{Фаззинг-тестирование}

Другой популярный подход к тестированию работы модулей ядра в редких сценариях работы ~--- \textbf{фаззинг-тестирование}. Этот подход применяется с целью намеренно вызвать сбои и достичь редких сценариев работы тестируемой программы. Суть работы инструментов фаззинг-тестирования заключается в генерации случайных данных, передаваемых в качестве параметров при взаимодействии с интерфейсом тестируемого ПО. В случае тестирования модулей ядра ОС инструменты фаззинг-тестирования генерируют случайные входные данные для системных вызовов.

\subsection{Характеристика систем тестирования}

Важнейшей метрикой, характеризующей качество подобных систем тестирования является \textbf{тестовое покрытие} исходного кода. Полнота тестового покрытия кода является предметом для множества исследований, в том числе в области тестирования файловых систем \cite{xfscover}. В частности, в данной работе будет рассмотрена проблема создания системы автоматизированного тестирования файловой системы JFFS2, а также исследование достигаемого тестового покрытия исходного кода этой файловой системы.

Анализ достигаемого тестового покрытия - неотъемлемая часть создания системы тестов. Разработчику инструмента тестирования важно понимать, какой функционал программы хорошо тестируется разрабатываемыми тестами, и какие участки исходного кода используются малое число раз и требуют дальнейшей разработки инструмента.

\newpage
