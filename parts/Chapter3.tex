\section{Исследование и построение решения задачи}
\label{sec:Chapter3} \index{Chapter3}

В данной главе будут подробно рассмотрены идеи, разработанные в ходе исследования и построения решения задачи. Реализации данных идей подробно описывается в следующией главе.

\subsection{Тестовое покрытие}

\textbf{Тестовое покрытие} является основной метрикой, характеризующей качество системы тестирования любой программы. Однако фукнционал модулей ядра операционной системы, и ФС в частности, во многом зависит от конфигурации окружения в котором она работает. То есть для получения полной информации о покрытии достигаемом при помощи тестового набора необходимо провести несколько экспериментов в различном окружении.

\subsection{Расширение тестового покрытия ФС}

Для расширения тестового покрытия исходного кода ФС, достигаемого при помощи тестового набора необходимо провести анализ основных функций тестируемой ФС и параметров конфигурации ее окружения, от которых зависит ее функционал.

\subsection{Функционал JFFS2}

Основные функции файловой системы JFFS2 можно разделить на несколько групп по их предназначению:

\begin{enumerate}
	\item \textbf{Основные операции с файлами}
	К этой группе относятся функции, отвечающие за основной функционал операций с файлами и каталогами и внутренними структурами  ФС. Этот базовый функционал является общим для всех ФС. К таким операциям относятся например чтение и запись данных в файл, создание и удаление файла или каталога и соответствующих им индексных дескрипторов, установка расширенных атрибутов файлов. Функции этой группы могут быть покрыты тестовыми наборами других ФС, так как являются частью общего для всей файловых систем функционала.
	\item \textbf{Функции контроля доступа}
	К этой группе относятся функции, отвечающие за контроль доступа к пользовательским данным и операции с внутренними структурами, отвечающими за это, например списком контроля доступа.
	\item \textbf{Функции взаимодействия с устройствами хранений}
	К этой группе относятся функции, определяющие тип устройства хранения с которым работает ФС и работающие с его блоками, например обеспечивающие выравнивание износа стираемых блоков.
	\item \textbf{Сборщик мусора}
	К этой группе относятся функции, обеспечивающие работу алгоритма сборщика мусора JFFS2. Этот алгоритм является специфичным для этой ФС и его функции могут не покрываться при стандартных сценариях.
	\item \textbf{Алгоритмы сжатия данных}
	В JFFS2 есть 4 различных алгоритма сжатия данных, состоящих из множества внутренних фукнций. Помимо функционала самих алгоритмов, в коде присутствуют функции, отвечающие за стратегию выбора алгоритма сжатия. Например выбор может производиться по приоритету, размеру сжатых данных или вынуждая ФС в любом случае использовать один алгоритм.
	\item \textbf{Обработчик ошибок}
	К этой группе относятся функции обрабатывающие ошибки и редко достигаемые в обычных сценариях работы ФС. Эти ошибки могут быть связаны с некорректным выделением памяти, несоответствием важных параметров образа и устройства, используемого для его подключения или невалидностью данных, по причине наличия ошибок во внутренней логике самой файловой системы. Функции этой группы лучше всего покрываются при помощи фаззинг-тестирования либо тестированием с \textbf{симуляцией сбоев}.
	\item \textbf{Обработка входных параметров команд}
	К этой группе относятся функции, обрабатывающие суперблок ФС и входные параметры при выполнении команды монтирования. Эти функции являются частью основного функционала любой ФС, однако могут быть выделены в отдельную группу, так как лучше покрываются не обычными тестовыми сценариями, а фаззинг-тестированием ввиду большой вариативности возможных входных параметров и образа ФС.
	\item \textbf{Функции работы с внутренними структурами}
	К этой группе относятся функции работающие со внутренними структурами, особенными для исследуемой ФС. Для JFFS2 такими структурами являются например сводные узлы и маркеры очистки блоков. Ввиду своего назначения, эти функции могут не покрываться обычными тестовыми наборами и требовать написания специализированных тестов.
\end{enumerate}

\subsection{Окружение файловой системы}

Функционал файловой системы зависит от множества параметров ее окружения. В данном разделе будут выделены факторы, от которых зависит функционал JFFS2.

Во-первых, для различных типов запоминающих устройств файловая система может использовать разные функции для работы с данными. Файловая система jffs2 по разному работает с устройствами технологии памяти типа NOR и NAND, а также имеет особый интерфейс взаимодействия с образами с несортированными блоками (UBI) и устройствами флэш-памяти dataflash, подключаемыми по шине SPI. 

Во-вторых, при тестировании заранее созданного образа ФС, тестируемый образ может быть создан с разнличными опциями. Для файловой системы JFFS2 опции команды mkfs, создающей образ ФС, могут быть использованы для задания размера выходного образа, размера стираемого блока, размера страницы, используемого алгоритма сжатия данных, используемой стратегии автоматического выбора алгоритма сжатия, используемого порядка бит в выходном образе и подключения либо отключения функционала расширенных аттрибутов файлов Linux. 

В-третьих, при тестировании команды монтирования, используемой для подключения файловой системы к единому дереву каталогов, могут быть указаны различные опции. При помощи опций общих для всех файловых систем можно устанавливать режим доступа к данным, содержащимся на подключаемом устройстве, например доступ только для чтения, либо для чтения и записи. С использованием опций специфичных для JFFS2 можно например выбрать используемый алгоритм сжатия данных.

В-четвертых, функционал собранного ядра операционной системы во многом определяется составленным на этапе сборки файлом конфигурации. Опции, определяемые в этом файле могут отвечать зя подключение определенных модулей ядра и указание параметров для этих модулей. Для модуля устройств на основе технологии памяти в конфигурационном файле могут быть указаны опции, отвечающие за подключение различных эмуляторов и определение их параметров, поддержку драйверов нужных для взаимодействия с различными чипами и контроллерами устройств памяти. Для файловой системы JFFS2 при помощи опций конфигурацонного файла подключается поддержка расширенных атрибутов Linux, поддержка буффера записи, использование структуры сводных узлов и маркеров очистки и поддержка различных алгоритмов сжатия. Также при помощи конфигурационных опций может быть выбрана стратегия автоматического выбора алгоритма сжатия. Например, строка "CONFIG\_JFFS2\_CMODE\_PRIORITY=y" в файле конфигурации ядра указывает файловой системе выбирать алгоритм сжатия на основе их приоритета, а строка "CONFIG\_JFFS2\_CMODE\_SIZE=y" указывает на выбор алгоритма сжатия на основе размера сжатых данных.

\subsection{Создание системы автоматизированного тестирования}

В соответствии с целью и поставленными в работе задачами, для создания системы автоматизированного тестирования файловой системы JFFS2 необходимо протестировать исследуемую ФС при помощи имеющихся решений, в процессе доработать или адаптировать необходимые инструменты, расширить покрытие достигаемое при использовании имеющихся решений, произведя запуск в различных конфигурациях окружения, протестировать функции обработки ошибок при помощи инструментов фаззинг-тестирования, и создать тесты, покрывающие редкие сценарии с использованием технологии внедрения ошибок.

\newpage
